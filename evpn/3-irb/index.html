<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Ivan Pepelnjak, ipSpace.net AG">
        <link rel="canonical" href="https://evpn.bgplabs.net/evpn/3-irb/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>Integrated Routing and Bridging (IRB) with EVPN &#171; VXLAN and EVPN Labs</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">VXLAN and EVPN Labs</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Home</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../.." class="dropdown-item">Labs Overview</a>
</li>
                                    
<li>
    <a href="../../3-upcoming/" class="dropdown-item">Upcoming Labs</a>
</li>
                                    
<li>
    <a href="../../99-about/" class="dropdown-item">About the Project</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Installation</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../1-setup/" class="dropdown-item">Installation and Setup</a>
</li>
                                    
<li>
    <a href="../../4-codespaces/" class="dropdown-item">Use GitHub Codespaces</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">VXLAN</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../vxlan/1-single/" class="dropdown-item">Extend a Single VLAN Segment with VXLAN</a>
</li>
                                    
<li>
    <a href="../../vxlan/2-complex/" class="dropdown-item">More Complex VXLAN Deployment Scenario</a>
</li>
                                    
<li>
    <a href="../../vxlan/3-irb/" class="dropdown-item">Routing between VXLAN Segments</a>
</li>
                                    
<li>
    <a href="../../vxlan/4-anycast/" class="dropdown-item">Anycast Gateways on VXLAN Segments</a>
</li>
                                    
<li>
    <a href="../../vxlan/5-vrf-lite/" class="dropdown-item">Implement VRF-Lite with VXLAN</a>
</li>
                                    
<li>
    <a href="../../vxlan/6-ipv6/" class="dropdown-item">Running VXLAN over an IPv6-only Underlay Network</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">EVPN</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../1-bridging/" class="dropdown-item">Build an EVPN-based MAC-VRF instance</a>
</li>
                                    
<li>
    <a href="../2-complex/" class="dropdown-item">More Complex EVPN/VXLAN Bridging Scenario</a>
</li>
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Integrated Routing and Bridging (IRB) with EVPN</a>
</li>
                                    
<li>
    <a href="../4-asym-irb/" class="dropdown-item">EVPN Asymmetric Integrated Routing and Bridging</a>
</li>
                                    
<li>
    <a href="../../services/1-pvlan/" class="dropdown-item">Building a Private VLAN with EVPN/VXLAN</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Designs</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../design/2-ebgp/" class="dropdown-item">EBGP-Only EVPN</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../2-complex/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../4-asym-irb/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>

                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3">
<div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
  <div class="navbar-header">
      <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
          <span class="fa fa-angle-down"></span>
      </button>
  </div>

  
  
  
  
  
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary"  style="margin-bottom: 1em;">
      <ul class="nav flex-column">
          
      <li class="nav-item" data-level="1"><a href="#integrated-routing-and-bridging-irb-with-evpn" class="nav-link">Integrated Routing and Bridging (IRB) with EVPN</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#req" class="nav-link">Device Requirements</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#start-the-lab" class="nav-link">Start the Lab</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#existing-device-configuration" class="nav-link">Existing Device Configuration</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#configure-integrated-routing" class="nav-link">Configure Integrated Routing</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#configure-vxlan-and-evpn" class="nav-link">Configure VXLAN and EVPN</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#tshoot" class="nav-link">Verification and Troubleshooting</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#evpn-routes-and-arp-resolution" class="nav-link">EVPN Routes and ARP Resolution</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#cheating" class="nav-link">Cheating</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="2"><a href="#reference-information" class="nav-link">Reference Information</a>
        <ul class="nav flex-column">
      <li class="nav-item" data-level="3"><a href="#wiring" class="nav-link">Lab Wiring</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#addr" class="nav-link">Lab Addressing</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#ospf" class="nav-link">OSPF Routing (Area 0)</a>
        <ul class="nav flex-column">
        </ul>
      </li>
      <li class="nav-item" data-level="3"><a href="#bgp" class="nav-link">BGP Routing</a>
        <ul class="nav flex-column">
        </ul>
      </li>
        </ul>
      </li>
        </ul>
      </li>
      </ul>
    </div>
  
  
  
  
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="integrated-routing-and-bridging-irb-with-evpn">Integrated Routing and Bridging (IRB) with EVPN</h1>
<p>In the <a href="../1-bridging/">previous lab exercises</a>, we created MAC-VRFs to extend isolated VLANs with VXLAN segments using the EVPN control plane. Now, we&rsquo;ll add routing to the mix: the switches using EVPN/VXLAN to extend VLANs will also route between them.</p>
<p>The lab topology is as simple as in the previous exercises: a pair of hosts per VLAN attached to two directly connected switches. The switches use these technologies:</p>
<ul>
<li>Anycast gateways to give the same first-hop gateway to all attached hosts</li>
<li>VXLAN to transport bridged or routed layer-2 frames across an IP backbone</li>
<li>EVPN control plane to propagate the endpoints&rsquo; MAC/IP addresses.</li>
</ul>
<p><img alt="Lab topology" src="../topology-irb.png" /></p>
<h3 id="req">Device Requirements</h3>
<p>You can use any device supported by the <em>netlab</em> <a href="https://netlab.tools/module/ospf/#platform-support">OSPF</a>, <a href="https://netlab.tools/module/bgp/#platform-support">BGP</a>, and <a href="https://netlab.tools/module/vlan/#platform-support">VLAN</a> configuration modules. The device should support VXLAN and EVPN.</p>
<h2 id="start-the-lab">Start the Lab</h2>
<p>Assuming you already <a href="../../1-setup/">set up your lab infrastructure</a>:</p>
<ul>
<li>Change directory to <code>evpn/3-irb</code></li>
<li>Execute <strong>netlab up</strong></li>
<li>Log into lab devices with <strong>netlab connect</strong> and verify that the IP addresses and the OSPF are properly configured.</li>
</ul>
<h2 id="existing-device-configuration">Existing Device Configuration</h2>
<ul>
<li>The switches in your lab (S1 and S2) are preconfigured with <em>red</em> and <em>blue</em> VLANs:</li>
</ul>
<table>
<thead>
<tr>
<th>VLAN</th>
<th style="text-align: right;">VLAN tag</th>
<th style="text-align: right;">IPv4 prefix</th>
</tr>
</thead>
<tbody>
<tr>
<td>red</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">172.16.10.0/24</td>
</tr>
<tr>
<td>blue</td>
<td style="text-align: right;">101</td>
<td style="text-align: right;">172.16.11.0/24</td>
</tr>
</tbody>
</table>
<ul>
<li>IPv4 addresses are configured on Linux hosts, switch loopback interfaces, and the interswitch link (<a href="#addr">details</a>).</li>
<li>Static routes pointing to the anycast gateway are configured on the Linux hosts:</li>
</ul>
<table>
<thead>
<tr>
<th>Host</th>
<th style="text-align: right;"> IPv4 prefix</th>
<th style="text-align: right;">Next hop</th>
</tr>
</thead>
<tbody>
<tr>
<td>HR1</td>
<td style="text-align: right;">172.16.0.0/16</td>
<td style="text-align: right;">172.16.10.42</td>
</tr>
<tr>
<td>HR2</td>
<td style="text-align: right;">172.16.0.0/16</td>
<td style="text-align: right;">172.16.10.42</td>
</tr>
<tr>
<td>HB1</td>
<td style="text-align: right;">172.16.0.0/16</td>
<td style="text-align: right;">172.16.11.42</td>
</tr>
<tr>
<td>HB2</td>
<td style="text-align: right;">172.16.0.0/16</td>
<td style="text-align: right;">172.16.11.42</td>
</tr>
</tbody>
</table>
<ul>
<li>The switches run OSPF in area 0 across the interswitch link (<a href="#ospf">details</a>).</li>
<li>The switches have an IBGP session between their loopback interfaces. The IBGP session is currently configured to exchange IPv4 prefixes (<a href="#bgp">details</a>).</li>
</ul>
<h2 id="configure-integrated-routing">Configure Integrated Routing</h2>
<p>You&rsquo;ll configure the <em>tenant</em> VRF<sup id="fnref:SPV"><a class="footnote-ref" href="#fn:SPV">1</a></sup>, IP addresses on switch VLAN interfaces, and anycast gateways before configuring VXLAN or EVPN:</p>
<ul>
<li>Create a <em>tenant</em> VRF and enable IP routing in that VRF</li>
<li>Put the <em>red</em> and <em>blue</em> VLAN interfaces into the <em>tenant</em> VRF</li>
<li>Configure the following IP addresses on S1 and S2:</li>
</ul>
<table>
<thead>
<tr>
<th>Node/Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>s1</strong></td>
<td style="text-align: right;"></td>
<td></td>
</tr>
<tr>
<td>Vlan100</td>
<td style="text-align: right;">172.16.10.1/24</td>
<td>VLAN red (100) -&gt; [hr1,hr2,s2] (VRF: tenant)</td>
</tr>
<tr>
<td>Vlan101</td>
<td style="text-align: right;">172.16.11.1/24</td>
<td>VLAN blue (101) -&gt; [hb1,hb2,s2] (VRF: tenant)</td>
</tr>
<tr>
<td><strong>s2</strong></td>
<td style="text-align: right;"></td>
<td></td>
</tr>
<tr>
<td>Vlan100</td>
<td style="text-align: right;">172.16.10.2/24</td>
<td>VLAN red (100) -&gt; [hr1,s1,hr2] (VRF: tenant)</td>
</tr>
<tr>
<td>Vlan101</td>
<td style="text-align: right;">172.16.11.2/24</td>
<td>VLAN blue (101) -&gt; [hb1,s1,hb2] (VRF: tenant)</td>
</tr>
</tbody>
</table>
<ul>
<li>Using the commands you mastered in the <a href="../../vxlan/4-anycast/">Anycast Gateways on VXLAN Segments</a> lab exercise, configure the anycast gateways (or active-active VRRP) on <em>red</em> and <em>blue</em> VLANs using these IP addresses:</li>
</ul>
<table>
<thead>
<tr>
<th>VLAN</th>
<th style="text-align: right;">Gateway IP address</th>
</tr>
</thead>
<tbody>
<tr>
<td>red</td>
<td style="text-align: right;">172.16.10.42/24</td>
</tr>
<tr>
<td>blue</td>
<td style="text-align: right;">172.16.11.42/24</td>
</tr>
</tbody>
</table>
<ul>
<li>Check that the local inter-VLAN routing works: HR1 should be able to reach HB1, and HR2 should be able to reach HB2</li>
<li>Verify that cross-switch VLAN connectivity does not work: HR1 cannot reach HR2, HB1 cannot reach HB2, and HR1 cannot reach HB2.</li>
</ul>
<h2 id="configure-vxlan-and-evpn">Configure VXLAN and EVPN</h2>
<p>Using the procedure you mastered in the <a href="../1-bridging/">Build an EVPN-based MAC-VRF instance</a> lab exercise, configure:</p>
<ul>
<li>EVPN address family on the S1-S2 IBGP session</li>
<li>MAC-VRF for the <em>red</em> and <em>blue</em> VLANs using these parameters:</li>
</ul>
<table>
<thead>
<tr>
<th>VLAN</th>
<th style="text-align: right;">VNI</th>
<th style="text-align: right;">route target</th>
</tr>
</thead>
<tbody>
<tr>
<td>red</td>
<td style="text-align: right;">10010</td>
<td style="text-align: right;">65000:100</td>
</tr>
<tr>
<td>blue</td>
<td style="text-align: right;">10011</td>
<td style="text-align: right;">65000:101</td>
</tr>
</tbody>
</table>
<p>Some platforms might require additional nerd knobs to make ARP resolution work. For example, you might have to configure an EVPN IP-VRF (with EVPN route targets but no route redistribution) or advertisements of router MAC addresses as EVPN routes.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>See <em>EVPN Routes and ARP Resolution</em> section for more details (the <a href="https://blog.ipspace.net/2025/04/evpn-symmetric-irb-arp/">ARP Challenges in EVPN/VXLAN Symmetric IRB</a> blog post describes a similar challenge). </p>
</div>
<h2 id="tshoot">Verification and Troubleshooting</h2>
<p>Use <strong>netlab validate</strong> or <strong>ping</strong> on hosts to verify that all hosts can reach each other:</p>
<pre><code>hr1:/# ping -c 3 hb2
PING hb2 (172.16.11.6): 56 data bytes
64 bytes from 172.16.11.6: seq=0 ttl=63 time=5.410 ms
64 bytes from 172.16.11.6: seq=1 ttl=63 time=2.072 ms
64 bytes from 172.16.11.6: seq=2 ttl=63 time=2.098 ms

--- hb2 ping statistics ---
3 packets transmitted, 3 packets received, 0% packet loss
round-trip min/avg/max = 2.072/3.193/5.410 ms
</code></pre>
<p>Use the <a href="../1-bridging/#tshoot">troubleshooting hints</a> from the <a href="../1-bridging/">Build an EVPN-based MAC-VRF instance</a> lab exercise if needed (we expect you&rsquo;re familiar with the traditional routing between VLAN segments).</p>
<p>If the inter-VLAN forwarding (routing) fails while the intra-VLAN forwarding (bridging) works, you probably have an ARP resolution problem. Inspect the EVPN routes and the VRF ARP tables on S1 and S2 to see whether S1 and S2 have all the necessary ARP entries for the attached hosts.</p>
<p class="code-caption">Sample VRF ARP table on S1 running Arista EOS (some ARP entries are derived from EVPN routes)<br /></p>
<pre><code>s1#show arp vrf tenant
Address         Age (sec)  Hardware Addr   Interface
172.16.10.2             -  001c.73e5.c589  Vlan100, Vxlan1
172.16.10.3       0:02:18  aac1.abee.f5ff  Vlan100, Ethernet2
172.16.11.2             -  001c.73e5.c589  Vlan101, Vxlan1
172.16.11.6             -  aac1.abc5.8066  Vlan101, Vxlan1
</code></pre>
<h2 id="evpn-routes-and-arp-resolution">EVPN Routes and ARP Resolution</h2>
<p>Each host uses the anycast gateway on the adjacent switch as the first-hop router. Our implementation is thus <em>asymmetric</em> Integrated Routing and Bridging (IRB) &ndash; the router in the HB1-HR2 path differs from the router in the HR2-HB1 path.</p>
<p><img alt="Lab topology" src="../../vxlan/packet-flow-irb.png" /></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You should be able to use the <em>traceroute</em> command to verify the asymmetric path. Unfortunately, some switches break traceroute because they don&rsquo;t send ICMP replies to packets received on the anycast gateway&rsquo;s MAC address.</p>
</div>
<p>Based on the above diagram, the inter-VLAN packet forwarding works only when:</p>
<ol>
<li>The ingress switch (S1) replies to an ARP request from the source host</li>
<li>The ingress switch can populate the ARP entry in the destination subnet to resolve the MAC address of the destination host</li>
<li>The same process works in the reverse direction on the egress switch (S2)</li>
</ol>
<p>A layer-3 switch (S1 or S2) can populate the ARP entries from EVPN routes or by using traditional ARP requests/replies:</p>
<ul>
<li>The ARP request is broadcast from the unicast MAC/IP address of the ingress switch into the destination subnet</li>
<li>The broadcast has to be propagated across the VXLAN segment and reach the destination host</li>
<li>The ARP response is sent to the unicast MAC address of the ingress switch. The ARP entry on the ingress switch will be created only if the ingress switch receives that response.</li>
</ul>
<p>With that in mind, let&rsquo;s inspect the EVPN routes we might see once the lab is working correctly (the presence of the MAC-IP routes depends on the aging of MAC/ARP entries). It&rsquo;s worth noting that you won&rsquo;t see any new EVPN route types; the switches originate only MAC-IP (type-2) and IMET (type-3) EVPN routes:</p>
<p class="code-caption">EVPN routes on S1 running Arista EOS<br /></p>
<pre><code>s1#show bgp evpn
BGP routing table information for VRF default
Router identifier 10.0.0.1, local AS number 65000
Route status codes: * - valid, &gt; - active, S - Stale, E - ECMP head, e - ECMP
                    c - Contributing to ECMP, % - Pending best path selection
Origin codes: i - IGP, e - EGP, ? - incomplete
AS Path Attributes: Or-ID - Originator ID, C-LST - Cluster List, LL Nexthop - Link Local Nexthop

          Network                Next Hop              Metric  LocPref Weight  Path
 * &gt;      RD: 10.0.0.2:100 mac-ip aac1.ab4c.bbaf
                                 10.0.0.2              -       100     0       i
 * &gt;      RD: 10.0.0.2:100 mac-ip aac1.ab4c.bbaf 172.16.10.4
                                 10.0.0.2              -       100     0       i
 * &gt;      RD: 10.0.0.1:100 mac-ip aac1.ab80.7a20
                                 -                     -       -       0       i
 * &gt;      RD: 10.0.0.1:100 mac-ip aac1.ab80.7a20 172.16.10.3
                                 -                     -       -       0       i
 * &gt;      RD: 10.0.0.2:101 mac-ip aac1.abd2.254b
                                 10.0.0.2              -       100     0       i
 * &gt;      RD: 10.0.0.2:101 mac-ip aac1.abd2.254b 172.16.11.6
                                 10.0.0.2              -       100     0       i
 * &gt;      RD: 10.0.0.1:100 imet 10.0.0.1
                                 -                     -       -       0       i
 * &gt;      RD: 10.0.0.1:101 imet 10.0.0.1
                                 -                     -       -       0       i
 * &gt;      RD: 10.0.0.2:100 imet 10.0.0.2
                                 10.0.0.2              -       100     0       i
 * &gt;      RD: 10.0.0.2:101 imet 10.0.0.2
                                 10.0.0.2              -       100     0       i
</code></pre>
<p class="code-caption">EVPN routes on S1 running FRRouting release 10.5.1<br /></p>
<pre><code>s1# show bgp l2vpn evpn
BGP table version is 5, local router ID is 10.0.0.1
Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal
Origin codes: i - IGP, e - EGP, ? - incomplete
EVPN type-1 prefix: [1]:[EthTag]:[ESI]:[IPlen]:[VTEP-IP]:[Frag-id]
EVPN type-2 prefix: [2]:[EthTag]:[MAClen]:[MAC]:[IPlen]:[IP]
EVPN type-3 prefix: [3]:[EthTag]:[IPlen]:[OrigIP]
EVPN type-4 prefix: [4]:[ESI]:[IPlen]:[OrigIP]
EVPN type-5 prefix: [5]:[EthTag]:[IPlen]:[IP]

   Network          Next Hop            Metric LocPrf Weight Path
Route Distinguisher: 10.0.0.1:100
 *&gt;  [2]:[0]:[48]:[aa:c1:ab:14:59:f8]
                    10.0.0.1(s1)                       32768 i
                    ET:8 RT:65000:100
 *&gt;  [2]:[0]:[48]:[aa:c1:ab:14:59:f8]:[32]:[172.16.10.3]
                    10.0.0.1(s1)                       32768 i
                    ET:8 RT:65000:100
 *&gt;  [2]:[0]:[48]:[ca:f4:00:01:00:00]:[32]:[172.16.10.1]
                    10.0.0.1(s1)                       32768 i
                    ET:8 RT:65000:100
 *&gt;  [3]:[0]:[32]:[10.0.0.1]
                    10.0.0.1(s1)                       32768 i
                    ET:8 RT:65000:100
Route Distinguisher: 10.0.0.1:101
 *&gt;  [2]:[0]:[48]:[ca:f4:00:01:00:01]:[32]:[172.16.11.1]
                    10.0.0.1(s1)                       32768 i
                    ET:8 RT:65000:101
 *&gt;  [3]:[0]:[32]:[10.0.0.1]
                    10.0.0.1(s1)                       32768 i
                    ET:8 RT:65000:101
Route Distinguisher: 10.0.0.2:100
 *&gt;i [2]:[0]:[48]:[ca:f4:00:02:00:00]:[32]:[172.16.10.2]
                    10.0.0.2(s2)                  100      0 i
                    RT:65000:100 ET:8
 *&gt;i [3]:[0]:[32]:[10.0.0.2]
                    10.0.0.2(s2)                  100      0 i
                    RT:65000:100 ET:8
Route Distinguisher: 10.0.0.2:101
 *&gt;i [2]:[0]:[48]:[aa:c1:ab:d0:5e:45]
                    10.0.0.2(s2)                  100      0 i
                    RT:65000:101 ET:8
 *&gt;i [2]:[0]:[48]:[ca:f4:00:02:00:01]:[32]:[172.16.11.2]
                    10.0.0.2(s2)                  100      0 i
                    RT:65000:101 ET:8
 *&gt;i [3]:[0]:[32]:[10.0.0.2]
                    10.0.0.2(s2)                  100      0 i
                    RT:65000:101 ET:8

Displayed 11 out of 11 total prefixes
</code></pre>
<p>The contents of the EVPN MAC-IP routes depend heavily on the EVPN implementation (proving yet again that EVPN is the SIP of networking):</p>
<ul>
<li>As the hosts have to send ARP requests to the switches (they use them as the default gateway), the switches discover the IP addresses (not just the MAC addresses) of the attached hosts. Some switches (for example, Arista EOS) originate MAC-IP routes with MAC and IP addresses; others (for example, FRR) do not (their MAC-IP routes contain only MAC addresses)</li>
<li>If a switch decides to advertise a host IP address in a MAC-IP route, it could originate a single MAC-IP route with both addresses, or revoke a route with the MAC address and replace it with another route with MAC and IP addresses. Arista EOS originates MAC-IP routes with and without IP addresses, effectively doubling the size of the EVPN BGP table.</li>
<li>A switch might not advertise the MAC and IP address of its VLAN interfaces as MAC-IP routes. You have to configure <strong>‌redistribute router-mac system ip</strong> in the MAC-VRF on Arista EOS or <strong>advertise-svi-ip</strong> on FRRouting EVPN address family to advertise the MAC and IP addresses of the VLAN interfaces as MAC-IP routes.</li>
</ul>
<p>Considering these details, it&rsquo;s easy to see an immediate interoperability challenge:</p>
<ul>
<li>FRRouting does not advertise host IP addresses in the MAC-IP EVPN routes.</li>
<li>Arista EOS cannot use the MAC-IP EVPN routes to populate the ARP cache</li>
<li>Arista EOS sends ARP requests to populate the ARP entries, but the source MAC address of the ARP request is not advertised as an EVPN route unless you configured <strong>‌redistribute router-mac system ip</strong>.</li>
</ul>
<p>Fortunately, Ethernet is forgiving (and loves to waste resources). Since the ingress switch&rsquo;s MAC address is unknown, the ARP reply sent to it is flooded across the VXLAN segment and eventually reaches the ingress switch.</p>
<h2 id="cheating">Cheating</h2>
<ul>
<li>Shut down your lab with the <strong>netlab down</strong> command</li>
<li>Start the lab from the <code>solution.yml</code> topology with the <strong>netlab up solution.yml</strong> command</li>
<li>Explore the S1/S2 device configuration</li>
</ul>
<h2 id="reference-information">Reference Information</h2>
<h3 id="wiring">Lab Wiring</h3>
<table>
<thead>
<tr>
<th>Origin Device</th>
<th>Origin Port</th>
<th>Destination Device</th>
<th>Destination Port</th>
</tr>
</thead>
<tbody>
<tr>
<td>s1</td>
<td>Ethernet1</td>
<td>s2</td>
<td>Ethernet1</td>
</tr>
<tr>
<td>hr1</td>
<td>eth1</td>
<td>s1</td>
<td>Ethernet2</td>
</tr>
<tr>
<td>hr2</td>
<td>eth1</td>
<td>s2</td>
<td>Ethernet2</td>
</tr>
<tr>
<td>hb1</td>
<td>eth1</td>
<td>s1</td>
<td>Ethernet3</td>
</tr>
<tr>
<td>hb2</td>
<td>eth1</td>
<td>s2</td>
<td>Ethernet3</td>
</tr>
</tbody>
</table>
<h3 id="addr">Lab Addressing</h3>
<table>
<thead>
<tr>
<th>Node/Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th style="text-align: right;">IPv6 Address</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>s1</strong></td>
<td style="text-align: right;">10.0.0.1/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.1/30</td>
<td style="text-align: right;"></td>
<td>s1 -&gt; s2</td>
</tr>
<tr>
<td><strong>s2</strong></td>
<td style="text-align: right;">10.0.0.2/32</td>
<td style="text-align: right;"></td>
<td>Loopback</td>
</tr>
<tr>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.2/30</td>
<td style="text-align: right;"></td>
<td>s2 -&gt; s1</td>
</tr>
<tr>
<td><strong>hr1</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td></td>
</tr>
<tr>
<td>eth1</td>
<td style="text-align: right;">172.16.10.3/24</td>
<td style="text-align: right;"></td>
<td>hr1 -&gt; [s1,hr2,s2]</td>
</tr>
<tr>
<td><strong>hr2</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td></td>
</tr>
<tr>
<td>eth1</td>
<td style="text-align: right;">172.16.10.4/24</td>
<td style="text-align: right;"></td>
<td>hr2 -&gt; [hr1,s1,s2]</td>
</tr>
<tr>
<td><strong>hb1</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td></td>
</tr>
<tr>
<td>eth1</td>
<td style="text-align: right;">172.16.11.5/24</td>
<td style="text-align: right;"></td>
<td>hb1 -&gt; [s1,hb2,s2]</td>
</tr>
<tr>
<td><strong>hb2</strong></td>
<td style="text-align: right;"></td>
<td style="text-align: right;"></td>
<td></td>
</tr>
<tr>
<td>eth1</td>
<td style="text-align: right;">172.16.11.6/24</td>
<td style="text-align: right;"></td>
<td>hb2 -&gt; [hb1,s1,s2]</td>
</tr>
</tbody>
</table>
<h3 id="ospf">OSPF Routing (Area 0)</h3>
<table>
<thead>
<tr>
<th>Router</th>
<th>Interface</th>
<th style="text-align: right;">IPv4 Address</th>
<th>Neighbor(s)</th>
</tr>
</thead>
<tbody>
<tr>
<td>s1</td>
<td>Loopback</td>
<td style="text-align: right;">10.0.0.1/32</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.1/30</td>
<td>s2</td>
</tr>
<tr>
<td>s2</td>
<td>Loopback</td>
<td style="text-align: right;">10.0.0.2/32</td>
<td></td>
</tr>
<tr>
<td></td>
<td>Ethernet1</td>
<td style="text-align: right;">10.1.0.2/30</td>
<td>s1</td>
</tr>
</tbody>
</table>
<h3 id="bgp">BGP Routing</h3>
<table>
<thead>
<tr>
<th>Node</th>
<th>Router ID/<br />Neighbor</th>
<th style="text-align: right;">Router AS/<br />Neighbor AS</th>
<th style="text-align: right;">Neighbor IPv4</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>s1</strong></td>
<td>10.0.0.1</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td></td>
<td>s2</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;">10.0.0.2</td>
</tr>
<tr>
<td><strong>s2</strong></td>
<td>10.0.0.2</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;"></td>
</tr>
<tr>
<td></td>
<td>s1</td>
<td style="text-align: right;">65000</td>
<td style="text-align: right;">10.0.0.1</td>
</tr>
</tbody>
</table>
<div class="footnote">
<hr />
<ol>
<li id="fn:SPV">
<p>Some platforms need VRFs to make integrated routing and bridging work with the EVPN control plane&#160;<a class="footnote-backref" href="#fnref:SPV" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
</ol>
</div></div>
            </div>
        </div>

        <footer class="col-md-12">
<hr>
    <p>(C) 2025 Ivan Pepelnjak (ipSpace.net AG)</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
